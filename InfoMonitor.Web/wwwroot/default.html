<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>InfoMonitor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" />
</head>
<body onload="addSection()">
    <div class="navbar navbar-expand-lg navbar-light bg-light" id="toolbar">
        <div class="my-2 my-lg-0">
            <button class="btn btn-outline-secondary" onclick="fetchUpdate()">Refresh</button>
            <button class="btn btn-outline-secondary" onclick="addSection()">Add</button>
            <span class="" id="status">Ready</span>
        </div>
    </div>
    <div class="container" id="sectionContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/linq@3.2.3/linq.min.js"></script>
    <script>
        let sections = [];
        let sectionContainer = $('#sectionContainer');
        let status = $('#status');
        let refreshing = false;
        let timer;

        function addSection() {
            let newId = sections.length.toString();
            let newSection = `<div class="card" id="${newId}section"><div class="card-header text-end"><div id="${newId}controls"><button class="btn btn-outlne-danger" onclick="removeSection(${newId})">X</button></div><div class="card-body"><textarea class="form-control" id="${newId}linq">//Add your code here and return the result \r\nreturn serverData[0];</textarea><textarea class="form-control" id="${newId}output"></textarea></div></div>`;
            sections.push(newId);
            sectionContainer.append(newSection);
        }
        function removeSection(sectionId) {
            $(`#${sectionId}section`).remove();
        }
        function fetchUpdate() {
            if (!refreshing) {
                refreshing = true;

                $.ajax({
                    url: "api/Get"
                }).done(function (data) {
                    status.text(`Updated ${goodDate()}`);
                    sections.forEach(function (item, index) {
                        var userFunc = new Function('serverData', $(`#${item}linq`).val());
                        $(`#${item}output`).val(JSON.stringify(userFunc(data)));
                        userFunc = null;
                    });
                }).fail(function () {
                    status.innerHTML = "Failed";
                });
            }
            refreshing = false;
        }
        function goodDate() {
            let now = new Date();
            return now.getFullYear() + "-" + prependZero(now.getMonth()) + "-" + prependZero(now.getDay()) + " " + prependZero(now.getHours()) + ":" + prependZero(now.getMinutes()) + ":" + prependZero(now.getSeconds());
        }
        function prependZero(input) {
            if (input < 10)
                return "0" + input;
            else
                return input
        }
    </script>
</body>
</html>